define("static/pages/p-member/pay_popup",["static/lib/handlebars/handlebars-amd","static/lib/pingpp/pingpp"],function(a,c){var h=function(a){this.type=a.type,this.payHost="http://pay.qiaobutang.com",this.commodityId=a.commodityId,this.title=a.title||"",this.price=a.price||"",this.commodityNo=a.commodityNo||1,this.invoice=a.invoice||!1,this.specialCb=a.specialCb,this.returnUrl=a.returnUrl,this.price?this.initPay({commodityId:this.commodityId}):this.init()};return h.prototype={init:function(){var a=this,c=a.payHost+"/pay/commodity/"+this.commodityId;$.ajax({type:"GET",url:c,xhrFields:{withCredentials:!0}}).done(function(c){200===c.resultCode&&(a.price=c.price/100,a.initPay(c))})},initPay:function(a){var c=this;"wx"===this.type?this.ajaxPay({commodityId:a.commodityId,channel:"wx_pub_qr",commodityNo:c.commodityNo,kind:1,returnUrl:c.returnUrl}):"zfb"===this.type&&this.ajaxPay({commodityId:a.commodityId,channel:"alipay_pc_direct",commodityNo:c.commodityNo,kind:1,returnUrl:c.returnUrl||window.location.href})},ajaxPay:function(a){var c=this;$.ajax({type:"POST",url:c.payHost+"/pay/charge/naive",xhrFields:{withCredentials:!0},data:a}).done(function(a){200===a.resultCode?c.handleInvoice(a.charge.orderNo,function(){c.handleSpecialCb(c.specialCb,a.charge,function(){if("wx"===c.type){var h=c.shareWeChat(a.charge.credential.wx_pub_qr),y=a.charge.amount/100,g=c.isInteger(y)?y:y.toFixed(2);c.renderPayWxPopup({qrCode:h,price:g,chargeId:a.charge.id,orderNO:a.charge.orderNo,title:c.title})}else"zfb"===c.type&&(window.localStorage.setItem("chargeId",a.charge.id),window.localStorage.setItem("chargePrice",c.price*c.commodityNo),window.localStorage.setItem("chargeOrderNo",a.charge.orderNo),c.initPingpp(a.charge))})}):($.Noty({text:"出错了",type:"error"}),c.clearClickLimit())})},handleInvoice:function(a,c){var h=this;"object"==typeof this.invoice?(this.invoice.orderNo=a,$.ajax({type:"POST",url:this.payHost+"/pay/invoice/create",xhrFields:{withCredentials:!0},data:this.invoice}).done(function(a){200===a.resultCode?c():($.Noty({text:a.message,type:"error"}),h.clearClickLimit())})):c()},handleSpecialCb:function(a,c,h){a?a(c,h):h()},initPingpp:function(a){c.createPayment(a,function(a,c){"success"==a||"fail"==a&&$.Noty({text:c.msg,type:"error"})})},shareWeChat:function(a){return"http://s.jiathis.com/qrcode.php?url="+encodeURIComponent(a)},renderPayWxPopup:function(c){var h=this,y=a.compile($("[data-template-name=pay_wx]").html()),g=$.extend({},OverlayPopup,{classNames:["popup","db-popup","db-popup__wx"],afterShow:function(){h.count=0,h.timer=setInterval(function(){h.pollingWx(c.chargeId,g)},2e3)},afterHide:function(){clearInterval(h.timer),h.clearClickLimit(),$.ajax({type:"POST",url:h.payHost+"/pay/order/cancel/"+c.orderNO,xhrFields:{withCredentials:!0}}).done(function(){})}});g.setContent(y(c)),g.show()},renderPayWxSucPopup:function(c){var h=a.compile($("[data-template-name=pay_wx_suc]").html()),y=$.extend({},OverlayPopup,{classNames:["popup","db-popup","db-popup__wx"],afterShow:function(){$(".db-wx__btn__positive").click(function(){y.hide(),window.location.reload()}),$(".db-wx__btn__negative").click(function(){0!==$("#export").length&&$("#export").trigger("click"),y.hide()})}});y.setContent(h(c)),y.show()},pollingWx:function(a,c){var h=this;h.count++,h.count<60?$.ajax({type:"GET",url:h.payHost+"/pay/poll/"+a,xhrFields:{withCredentials:!0}}).done(function(a){200===a.resultCode&&a.isPaid&&(clearInterval(h.timer),c.hide(),h.renderPayWxSucPopup({state:!0,message:"购买成功！",price:h.price*h.commodityNo}),h.returnUrl&&(window.location.href=h.returnUrl))}):(c.hide(),h.renderPayWxSucPopup({state:!1,message:"支付超时,请重新选择获取方式",price:h.price}))},isInteger:function(a){return"number"==typeof a&&a%1===0},clearClickLimit:function(){$(".qbt-pay__wx, .qbt-pay__zfb").removeClass("hasClicked")}},h});